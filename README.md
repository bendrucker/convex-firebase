convex-firebase [![Build Status](https://travis-ci.org/bendrucker/convex-firebase.svg?branch=master)](https://travis-ci.org/bendrucker/convex-firebase) [![Code Climate](https://codeclimate.com/github/bendrucker/convex-firebase/badges/gpa.svg)](https://codeclimate.com/github/bendrucker/convex-firebase) [![Test Coverage](https://codeclimate.com/github/bendrucker/convex-firebase/badges/coverage.svg)](https://codeclimate.com/github/bendrucker/convex-firebase)
===============

Read-only Firebase bindings for convex, the most powerful ORM for Angular.

## Installation

```bash
$ npm install convex-firebase
```

## Setup

```js
angular.module('myApp', [
  require('convex'),
  require('convex-firebase')
]);
```

convex-firebase expects to find Firebase as `window.Firebase` and exposes a `Firebase` service for injection for convenience.

## API

### `ConvexModel`

##### `$ref(collection)` -> `reference`

Utility method used internally for generating Firebase references. `convexConfig.firebase` defines the base path of the Firebase endpoint. By default, `$ref` calls `model.$path` with `false` if a `collection` is passed and `true` otherwise. It calls `ref.child` with the path generated by `$path` to create a child reference.

You can define a `$firebase` object on the prototype of your model with a method `path` to generate a custom path. `$firebase.path` will be called in place of `$path` with the value of `collection` instead of a boolean and will be called with the model instance as `this`.

Example: Simple

```js
app
  .value('convexConfig', {
    firebase: 'https://example.firebaseio.com'
  })
  .factory('Book', function (ConvexModel) {
    return ConvexModel.extend({
      $name: 'book'
    });
  })
  .controller('BookController', function (Book) {
    var book = new Book({
      id: 123
    });
    assert.equal(
      book.$ref().toString(),
      'https://example.firebaseio.com/books/123'
    );
    assert.equal(
      book.$ref(true).toString(),
      'https://example.firebaseio.com/books'
    );
  });
```

Example: Custom Path

```js
app
  .factory('Author', function (ConvexModel) {
    return ConvexModel.extend({
      $name: 'author'
    })
    .hasMany('Book');
  })
  .factory('Book', function (ConvexModel) {
    return ConvexModel.extend({
      $name: 'book',
      $firebase: {
        path: function (collection) {
          return this.author.$path(true) + this.$path(collection);
        }
      }
    })
    .belongsTo('Author');
  })
  .controller('BookController', function (Book) {
    var book = new Book({
      id: 123
      author: {
        id: 456
      }
    });
    assert.equal(
      book.$ref().toString(),
      'https://example.firebaseio.com/authors/456/books/123'
    );
    assert.equal(
      book.$ref(true).toString(),
      'https://example.firebaseio.com/authors/456/books'
    );
  });
```

<hr>

##### `$subscribe(key|keys [, prefix])` -> `promise(model)`

Subscribes to updates on a single `key` (`key` is a string) or multiple `keys` (array). If `prefix` is set to `true`, the keys will be prefixed with `'$$'` on the model and in turn will not be serialized when the model is saved.

`$subscribe` returns a promise that resolves when data arrives once for all keys.

```js
model.$subscribe('status', true)
  .then(function (model) {
    assert(model.$$status);
  });
```

<hr>

### `ConvexCollection`

##### `$ref` -> `reference`

Generates a Firebase reference for a collection. This will call the `$ref` method on the prototype of the collection's `Model` constructor, passing itself as `collection` to allow access to collection properties in a `$firebase.path` method.

`Model.prototype.$firebase` may also define a `query`, where query is either:

* a function which will be called with the generated reference and should return a query
* an object that defines query methods to call and the arguments to supply (order is not guaranteed)

```js
ConvexModel.extend({
  $name: 'book',
  $firebase: {
    query: {
      limitToLast: 5
    }
  }
});
```

```js
ConvexModel.extend({
  $name: 'book',
  $firebase: {
    path: function (collection) {
      var path = this.$path(!collection);
      return collection ? path += collection.author.$path(true) : path;
    },
    query: function (ref) {
      return ref.limitToLast(5);
    }
  }
});
```

##### `$subscribe(options)` -> `undefined`

Subscribes to updates on all models in the collection via `'child_added'`, `'child_changed'`, and `'child_removed'` events. `'child_moved'` events are not yet supported.

`$subscribe` maintains an internal index that maps Firebase reference keys to the index of each model in a collection's array of models. This allows for performant updates and removal even for large collections of data. Modifying the order of items in a collection directly or removing entries will results in undesired behavior.
